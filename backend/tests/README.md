# Backend Tests Directory

This directory contains test infrastructure for the VyOS Web UI backend.

## Test Files

### Unit Tests (`unit_tests.rs`)
Contains unit tests for individual components without external dependencies:
- Error handling and status codes
- Model conversions
- Configuration parsing
- Authentication logic (password hashing, JWT claims)
- Input validation
- Middleware behavior

### Integration Tests (`integration_tests.rs`)
Contains integration tests that verify the full stack:
- API endpoint responses
- Request/response validation
- Authentication flow
- Configuration management
- System operations
- User management
- Error handling
- CORS support

### API Verification Script (`verify_api_endpoints.sh`)
Bash script that tests all API endpoints:
- Verifies endpoint availability
- Checks HTTP status codes
- Validates response structure
- Generates test report

## Running Tests

### Unit Tests
```bash
# Run all unit tests
cargo test

# Run only unit tests
cargo test --lib

# Run with output
cargo test -- --nocapture
```

### Integration Tests
```bash
# Run integration tests
cargo test --test integration_tests

# Run specific test
cargo test test_health_check --test integration_tests
```

### API Verification Script
```bash
# Run with default URL (http://localhost:8080)
./verify_api_endpoints.sh

# Run with custom URL
./verify_api_endpoints.sh http://localhost:3000
```

## Test Environment Setup

### Environment Variables
For integration tests, set the following environment variables:

```bash
# Database
TEST_DATABASE_URL=sqlite:test_database.db

# Authentication
TEST_JWT_SECRET_KEY=test_secret_key_for_testing_only
TEST_JWT_EXPIRATION_MINUTES=60

# VyOS API (optional, for VyOS integration tests)
TEST_VYOS_API_URL=https://vyos.example.com:8443
TEST_VYOS_API_USERNAME=testuser
TEST_VYOS_API_PASSWORD=testpass

# Server
TEST_SERVER_HOST=127.0.0.1
TEST_SERVER_PORT=8080
```

### Test Database
The tests use an in-memory SQLite database for testing. The schema is automatically
created from the migrations in `../migrations/`.

## Test Coverage

The following components are currently covered by tests:

### Currently Covered
- Error type definitions and status codes
- Model conversion logic
- Configuration loading
- Validation rules
- Basic API endpoint structure

### To Be Covered
- Service layer business logic
- Database operations
- Authentication flow (register, login, logout)
- JWT token generation and validation
- WebSocket connections
- VyOS API integration
- Configuration management operations
- System operations (reboot, poweroff, image management)

## Test Organization

```
backend/tests/
├── unit_tests.rs           # Unit tests for individual components
├── integration_tests.rs    # Integration tests for full API
├── verify_api_endpoints.sh # Bash script for endpoint verification
├── README.md               # This file
└── api_verification_results.txt # Generated by verification script
```

## Continuous Integration

These tests are designed to run in CI/CD pipelines:

```yaml
# Example GitHub Actions workflow
- name: Run unit tests
  run: cargo test --lib

- name: Run integration tests
  run: cargo test --test integration_tests
  env:
    TEST_DATABASE_URL: sqlite::memory:
    TEST_JWT_SECRET_KEY: ${{ secrets.TEST_JWT_SECRET }}
```

## Troubleshooting

### Cargo Check Fails Due to Dependency Version
If you encounter an error like:
```
error: failed to download `base64ct v1.8.3`
feature `edition2024` is required
```

This indicates your Cargo version is too old. Update Rust:

```bash
rustup update
rustup install nightly
```

### Database Connection Errors
Ensure the test database is properly configured:
```bash
export TEST_DATABASE_URL=sqlite:test.db
cargo test
```

### Authentication Token Errors
Ensure JWT secret is set for integration tests:
```bash
export TEST_JWT_SECRET_KEY=test_secret_for_testing
cargo test --test integration_tests
```

## Contributing Tests

When adding new features, follow these guidelines:

1. **Unit Tests**: Add tests for new models, services, and utility functions
2. **Integration Tests**: Add endpoint tests for new API routes
3. **API Verification**: Update `verify_api_endpoints.sh` if adding new endpoints
4. **Documentation**: Update this README with new test coverage

### Test Naming Convention
- Unit tests: `test_<module>_<functionality>`
- Integration tests: `test_<endpoint>_<scenario>`

### Test Structure
```rust
#[actix_web::test]
async fn test_endpoint_scenario() {
    // Arrange: Set up test data
    let app = test::init_service(/* ... */).await;

    // Act: Make request
    let req = test::TestRequest::get().uri("/endpoint").to_request();
    let resp = test::call_service(&app, req).await;

    // Assert: Verify response
    assert!(resp.status().is_success());
    let body: serde_json::Value = test::read_body_json(resp).await;
    assert_eq!(body["field"], "expected_value");
}
```

## License

Part of the VyOS Web UI project. See main project LICENSE file.